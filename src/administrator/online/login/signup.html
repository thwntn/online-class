<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./assets/style/login.css">
    <link rel="stylesheet" href="./assets/style/signup.css">
    <link rel="stylesheet" href="./assets/framework/css/bootstrap.css">
    <script src='./assets/framework/js/bootstrap.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

    <!-- Font Awaresome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <!-- MD5 -->
    <script src="./assets/js/md5.js"></script>
</head>

<body>
    <div id="root">
        <div class="header">
            <ul>
                <li>Trang chủ</li>
                <li>Liên hệ</li>
                <li>Thông tin</li>
            </ul>
            <ul>
                <li>Ngôn ngữ</li>
                <li class="active">Đăng kí</li>
                <li class="registry">Đăng nhập</li>
            </ul>
        </div>
        <div class="container-fluid">
            <div class="frame row">
                <div class="img_desk col-md-6"  style="background-image: url(./assets/image/sun.png);">
                    <h1>Chào mừng bạn!</h1>
                    <p>Đến với trang đăng nhập vui lòng nhâp tài khoản và mật khẩu <br> chúng tôi sẽ đưa bạn đến deadline <br> của bạn! :)</p>
                </div>
                <div class="content col-md-8">
                    <label class="username_err"></label>
                    <input class="username" type="text" placeholder="Tên tài khoản hoặc email">
                    <label class="password_err"></label>
                    <input class="password" type='password' placeholder="Nhập mật khẩu">
                    <label class="fullname_err"></label>
                    <input class="fullname" type='text' placeholder="Nhập tên đầy đủ">
                    <label class="address_err"></label>
                    <input class="address" type='text' placeholder="Nhập địa chỉ">
                    <label class="phone_err"></label>
                    <input class="phone" type='text' placeholder="Nhập số điện thoại">
                    <label class="email_err"></label>
                    <input class="email" type='text' placeholder="Nhập email">
                    <div class="sex">
                        <button class="choose-sex" data = 1>Nam</button>
                        <button class="choose-sex" data = 2>Nữ</button>
                        <button class="choose-sex" data = 0>Khác</button>
                    </div>
                    <label class="major_err"></label>
                    <input class="major" type='pasword' placeholder="Nhập ngành học">
                    <div class="type">
                        <button class="choose-type" data = 9>Giáo viên</button>
                        <button class="choose-type" data = 8>Học sinh</button>
                    </div>
                    <input class="upload" type='file'>
                    <button class="choose-file">Chưa chọn file</button>
                    <button class="submit">Đăng kí</button>
                </div>
            </div>
        </div>
        <div class="capcha">
            <input type="text" placeholder="Vui lòng nhập mã xác thực được gửi đến mail của bạn!">
        </div>
        <div class="err">
            <div class="err_warning">
                <i class="fas fa-exclamation flex"></i>
                <h5>Vui lòng điền đầy đủ thông tin</h5>
            </div>
        </div>
    </div>
</body>
<script>
    const information = {
        status: false,
        data: {
            username: null,
            password: null,
            fullname: null,
            address: null,
            phone: null,
            email: null,
            major: null,
            gendle: null,
            type: null,
            image: 'abc'
        },

        isLetter: (string) => {
            return string.toLowerCase() !== string.toUpperCase()
        },

        check: function() {
            console.log(this.isLeter);

        },

        checkString: function() {
            for (char of this.data.username) {
                if(!this.isLetter(char)) {
                    return false
                }
            }
            return true
        },

        setData: function(key, value) {
            return this.data[`${key}`] = value
        },

        signUp: function() {
            url = 'http://localhost/online-class/src/administrator/api/signup.php'
            fetch(url, {
                method: 'post',
                mode: 'cors',
                cache: 'no-cache',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                referrerPolicy: 'no-referrer',
                body: JSON.stringify(this.data)
            })
            .then((response) => response.json())
            .then((responseJson) => {
                if(responseJson == 1) {
                    fetch('http://localhost/online-class/src/administrator/api/authen_start.php', {
                        method: 'post',
                        mode: 'cors',
                        cache: 'no-cache',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'text/html'
                        },
                        redirect: 'follow',
                        referrerPolicy: 'no-referrer',
                        body: JSON.stringify(
                            {
                                username: this.data['username'],
                                email: this.data['email']
                            }
                        )
                    })
                    .then(responseAu => responseAu.json())
                    .then((responseJsonAu) => {
                        if(responseJsonAu == 1) {
                            location.href = 'http://localhost/online-class/src/administrator/online/login/authentication.html'
                        }
                        else {
                            console.log('err');
                        }
                    })
                }
            })
        },

        checkData: function () {
            let usrErr = $('.username_err')

            if(!this.checkString(this.data.username) || (this.data.username.length < 4) || (this.data.username.length > 16)) {
                usrErr.html('Tên tài khoản có độ dài 4 đến 16, a - z!')
                return false
            } else {
                usrErr.html(null)
            }

            url = 'http://localhost/online-class/src/administrator/api/checkusername.php'
            fetch(url, {
                method: 'post',
                mode: 'cors',
                cache: 'no-cache',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                referrerPolicy: 'no-referrer',
                body: JSON.stringify(this.data['username'])
            })
            .then(response => response.json())
            .then(responseJson => {
                if(responseJson == 1) {
                    usrErr.html('Tên đăng nhập đã tồn tại')
                } else {
                usrErr.html(null)
                }
            })
            let errPass = $('.password_err')
            let iPass = $('.password').val().length
            if(iPass < 8 || iPass > 16) {
                errPass.html('Mật khẩu phải có chiều dài từ 8 - 16 kí tự')
                return false
            } else {
                errPass.html(null)
            }

            //Phone
            let errPhone = $('.phone_err')
            if(this.data.phone.length > 13) {
                errPhone.html('Số điện thoại phải là số có chiều dài dưới 13 số')
                return false
            }
            else if (this.data.phone / 1 != this.data.phone) {
                errPhone.html('Chỉ được chứa số')
                return false
            } else {
                errPhone.html(null)
            }

            let errEmail = $('.email_err')
            let email = $('.email')
            if((email.slice(-10) == '@gmail.com') && (email.slice(-19) == '@student.ctu.edu.vn')){
                errEmail.html('Email phải có dạng @gmail.com hoặc @student.ctu.edu.vn')
                console.log(1);
                return false
            } else {
                errEmail.html(null)
            }

            usrErr.html(null)
            return true
        },

        
        handle: function () {
            $('.submit').on('click', () => {
                this.status = this.checkData()
                if(this.status) {
                    this.signUp()
                }
                else {
                    let err = $('.err')
                    err.css('display', 'flex')
                    setTimeout(() => {
                        err.css('display', 'none')
                    }, 2000);
                }
            })

            $('.choose-sex').on('click', () => {
                this.setData('gendle', $('.choose-sex').attr('data'))
            })

            $('.choose-type').on('click', () => {
                this.setData('type', $('.choose-type').attr('data'))
            })

            $('.content').on('change', () => {
                const reSet = () => {
                    this.setData('username', $('.username').val())
                    this.setData('password', md5($('.password').val()))
                    this.setData('address', $('.address').val())
                    this.setData('phone', $('.phone').val())
                    this.setData('major', $('.major').val())
                    this.setData('email', $('.email').val())
                    this.setData('fullname', $('.fullname').val())
                }

                reSet()          
            })

            document.querySelector('.registry').addEventListener('click', () => {
                location.href = 'http://localhost/online-class/src/administrator/online/login/login.html'
            })
        },

        enforcement: function() {
            this.handle()
        }
    }

    information.enforcement()

    document.querySelector('.choose-file').addEventListener('click', function () {
        document.querySelector('.upload').click()
    })

    document.querySelector('.upload').addEventListener('change', function () {
        document.querySelector('.choose-file').innerHTML = document.querySelector('.upload').value
    })

    
    const chooseSexs = document.querySelectorAll('.choose-sex')
    for (item of chooseSexs) {
        item.addEventListener('click', function () {
            for (item of chooseSexs) {
                item.style.background = 'none'
                item.style.color = 'black'
            }
            this.style.backgroundColor = 'rgba(0, 0, 255, 0.8'
            this.style.opacity = '60%'
            this.style.color = 'white'
        })
    }
    const chooseTypes = document.querySelectorAll('.choose-type')
    for (item of chooseTypes) {
        item.addEventListener('click', function () {
            for (item of chooseTypes) {
                item.style.background = 'none'
                item.style.color = 'black'
            }
            this.style.backgroundColor = 'rgba(0, 0, 255, 0.8'
            this.style.opacity = '60%'
            this.style.color = 'white'
        })
    }
</script>

</html>